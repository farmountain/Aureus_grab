apiVersion: batch/v1
kind: CronJob
metadata:
  name: database-migration
  namespace: aureus
  labels:
    app: database-migration
spec:
  schedule: "0 2 * * *"  # Run at 2 AM daily
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: 3
      template:
        metadata:
          labels:
            app: database-migration
        spec:
          restartPolicy: Never
          containers:
            - name: migration
              image: ghcr.io/farmountain/aureus-console:latest
              command:
                - /bin/sh
                - -c
                - |
                  echo "Starting database migration check..."
                  npm run db:migrate
                  if [ $? -eq 0 ]; then
                    echo "✅ Migration completed successfully"
                  else
                    echo "❌ Migration failed"
                    exit 1
                  fi
              env:
                - name: DB_HOST
                  valueFrom:
                    configMapKeyRef:
                      name: aureus-config
                      key: DB_HOST
                - name: DB_PORT
                  valueFrom:
                    configMapKeyRef:
                      name: aureus-config
                      key: DB_PORT
                - name: DB_NAME
                  valueFrom:
                    configMapKeyRef:
                      name: aureus-config
                      key: DB_NAME
                - name: DB_USER
                  valueFrom:
                    configMapKeyRef:
                      name: aureus-config
                      key: DB_USER
                - name: DB_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: aureus-secrets
                      key: DB_PASSWORD
                - name: NODE_ENV
                  value: "production"
              resources:
                requests:
                  cpu: 100m
                  memory: 256Mi
                limits:
                  cpu: 500m
                  memory: 512Mi
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: database-backup
  namespace: aureus
  labels:
    app: database-backup
spec:
  schedule: "0 1 * * *"  # Run at 1 AM daily
  successfulJobsHistoryLimit: 7
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: 2
      template:
        metadata:
          labels:
            app: database-backup
        spec:
          restartPolicy: Never
          containers:
            - name: backup
              image: postgres:15-alpine
              command:
                - /bin/sh
                - -c
                - |
                  echo "Starting database backup..."
                  BACKUP_FILE="/backups/aureus_backup_$(date +%Y%m%d_%H%M%S).sql"
                  
                  pg_dump -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -F p -f $BACKUP_FILE
                  
                  if [ $? -eq 0 ]; then
                    gzip $BACKUP_FILE
                    echo "✅ Backup completed: ${BACKUP_FILE}.gz"
                    
                    # Clean up backups older than 30 days
                    find /backups -name "aureus_backup_*.sql.gz" -mtime +30 -delete
                    echo "✅ Old backups cleaned up"
                  else
                    echo "❌ Backup failed"
                    exit 1
                  fi
              env:
                - name: DB_HOST
                  valueFrom:
                    configMapKeyRef:
                      name: aureus-config
                      key: DB_HOST
                - name: DB_PORT
                  valueFrom:
                    configMapKeyRef:
                      name: aureus-config
                      key: DB_PORT
                - name: DB_NAME
                  valueFrom:
                    configMapKeyRef:
                      name: aureus-config
                      key: DB_NAME
                - name: DB_USER
                  valueFrom:
                    configMapKeyRef:
                      name: aureus-config
                      key: DB_USER
                - name: PGPASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: aureus-secrets
                      key: DB_PASSWORD
              volumeMounts:
                - name: backup-storage
                  mountPath: /backups
              resources:
                requests:
                  cpu: 250m
                  memory: 512Mi
                limits:
                  cpu: 1000m
                  memory: 1Gi
          volumes:
            - name: backup-storage
              persistentVolumeClaim:
                claimName: database-backup-pvc
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: database-backup-pvc
  namespace: aureus
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 100Gi
