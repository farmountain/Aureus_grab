<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitoring Dashboard - Aureus Console</title>
  <script src="/persona-utils.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 5px;
    }

    .header p {
      opacity: 0.9;
      font-size: 14px;
    }

    .nav-links {
      display: flex;
      gap: 15px;
    }

    .nav-link {
      color: white;
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.2);
      transition: background 0.2s;
    }

    .nav-link:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .controls {
      padding: 20px 30px;
      background: #f7f9fc;
      border-bottom: 1px solid #e1e8ed;
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .control-group label {
      font-weight: 500;
      color: #4a5568;
      font-size: 14px;
    }

    .control-group select,
    .control-group input {
      padding: 8px 12px;
      border: 1px solid #e1e8ed;
      border-radius: 6px;
      font-size: 14px;
      background: white;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
    }

    .btn-secondary {
      background: #e1e8ed;
      color: #4a5568;
    }

    .btn-secondary:hover {
      background: #cbd5e0;
    }

    .content {
      padding: 30px;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .metric-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .metric-card.success {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .metric-card.warning {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .metric-card.info {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .metric-label {
      font-size: 12px;
      opacity: 0.9;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .metric-value {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .metric-subtitle {
      font-size: 13px;
      opacity: 0.85;
    }

    .section {
      background: #f7f9fc;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #2d3748;
    }

    .timeline {
      background: white;
      border-radius: 8px;
      overflow: hidden;
    }

    .timeline-item {
      padding: 15px 20px;
      border-bottom: 1px solid #e1e8ed;
      display: flex;
      gap: 15px;
      align-items: flex-start;
      transition: background 0.2s;
    }

    .timeline-item:hover {
      background: #f7f9fc;
    }

    .timeline-item:last-child {
      border-bottom: none;
    }

    .timeline-marker {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-top: 5px;
      flex-shrink: 0;
    }

    .timeline-marker.success {
      background: #38ef7d;
    }

    .timeline-marker.failure {
      background: #f5576c;
    }

    .timeline-marker.info {
      background: #4facfe;
    }

    .timeline-marker.warning {
      background: #ffa94d;
    }

    .timeline-content {
      flex: 1;
    }

    .timeline-time {
      font-size: 12px;
      color: #8492a6;
      margin-bottom: 4px;
    }

    .timeline-type {
      font-size: 11px;
      color: white;
      background: #667eea;
      padding: 2px 8px;
      border-radius: 4px;
      display: inline-block;
      margin-bottom: 4px;
    }

    .timeline-description {
      font-size: 14px;
      color: #4a5568;
      margin-bottom: 4px;
    }

    .timeline-details {
      font-size: 12px;
      color: #718096;
    }

    .benchright-panel {
      background: white;
      border-radius: 8px;
      overflow: hidden;
    }

    .benchright-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      padding: 20px;
      background: #f7f9fc;
      border-bottom: 1px solid #e1e8ed;
    }

    .benchright-metric {
      background: white;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #e1e8ed;
    }

    .benchright-metric-label {
      font-size: 12px;
      font-weight: 600;
      color: #8492a6;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .benchright-metric-value {
      font-size: 24px;
      font-weight: 700;
      color: #2d3748;
    }

    .benchright-metric-subtitle {
      font-size: 11px;
      color: #8492a6;
      margin-top: 4px;
    }

    .benchright-scores {
      padding: 20px;
    }

    .score-card {
      padding: 20px;
      border-bottom: 1px solid #e1e8ed;
      transition: background 0.2s;
    }

    .score-card:hover {
      background: #f7f9fc;
    }

    .score-card:last-child {
      border-bottom: none;
    }

    .score-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .score-title {
      font-size: 14px;
      font-weight: 600;
      color: #4a5568;
    }

    .score-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 700;
    }

    .score-grade-A {
      background: #c6f6d5;
      color: #22543d;
    }

    .score-grade-B {
      background: #bee3f8;
      color: #2c5282;
    }

    .score-grade-C {
      background: #feebc8;
      color: #7c2d12;
    }

    .score-grade-D {
      background: #fed7d7;
      color: #742a2a;
    }

    .score-grade-F {
      background: #feb2b2;
      color: #742a2a;
    }

    .score-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }

    .score-metric {
      display: flex;
      flex-direction: column;
    }

    .score-metric-label {
      font-size: 11px;
      color: #8492a6;
      margin-bottom: 4px;
    }

    .score-metric-value {
      font-size: 16px;
      font-weight: 600;
      color: #2d3748;
    }

    .counterfactual-section {
      margin-top: 12px;
      padding: 12px;
      background: #f7f9fc;
      border-radius: 6px;
    }

    .counterfactual-title {
      font-size: 12px;
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 8px;
    }

    .counterfactual-comparison {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 12px;
      align-items: center;
      margin-bottom: 8px;
    }

    .counterfactual-outcome {
      padding: 8px 12px;
      background: white;
      border-radius: 4px;
      text-align: center;
      font-size: 12px;
    }

    .counterfactual-arrow {
      font-size: 20px;
      color: #8492a6;
    }

    .intervention-value {
      font-size: 12px;
      color: #4a5568;
      margin-top: 8px;
    }

    .intervention-value-high {
      color: #22543d;
      font-weight: 600;
    }

    .intervention-value-medium {
      color: #7c2d12;
      font-weight: 600;
    }

    .intervention-value-low {
      color: #742a2a;
      font-weight: 600;
    }

    .reflexion-panel {
      background: white;
      border-radius: 8px;
      overflow: hidden;
    }

    .alerts-panel {
      background: white;
      border-radius: 8px;
      overflow: hidden;
    }

    .alert-card {
      padding: 20px;
      border-bottom: 1px solid #e1e8ed;
      border-left: 4px solid;
      display: flex;
      align-items: flex-start;
      gap: 15px;
    }

    .alert-card:last-child {
      border-bottom: none;
    }

    .alert-card.critical {
      border-left-color: #e53e3e;
      background: #fff5f5;
    }

    .alert-card.warning {
      border-left-color: #ed8936;
      background: #fffaf0;
    }

    .alert-card.info {
      border-left-color: #3182ce;
      background: #ebf8ff;
    }

    .alert-icon {
      font-size: 24px;
      min-width: 24px;
    }

    .alert-content {
      flex: 1;
    }

    .alert-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .alert-title {
      font-size: 16px;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 4px;
    }

    .alert-time {
      font-size: 12px;
      color: #8492a6;
    }

    .alert-severity {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .alert-severity.critical {
      background: #fed7d7;
      color: #742a2a;
    }

    .alert-severity.warning {
      background: #feebc8;
      color: #7c2d12;
    }

    .alert-severity.info {
      background: #bee3f8;
      color: #2c5282;
    }

    .alert-message {
      font-size: 14px;
      color: #2d3748;
      line-height: 1.6;
      margin-bottom: 10px;
    }

    .alert-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      font-size: 13px;
    }

    .alert-detail {
      display: flex;
      flex-direction: column;
    }

    .alert-detail-label {
      font-size: 11px;
      font-weight: 600;
      color: #718096;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 2px;
    }

    .alert-detail-value {
      color: #2d3748;
      font-weight: 500;
    }

    .alert-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .alert-actions .btn {
      font-size: 13px;
      padding: 6px 12px;
    }

    .postmortem-card {
      padding: 20px;
      border-bottom: 1px solid #e1e8ed;
    }

    .postmortem-card:last-child {
      border-bottom: none;
    }

    .postmortem-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .postmortem-title {
      font-size: 16px;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 5px;
    }

    .postmortem-meta {
      font-size: 12px;
      color: #8492a6;
    }

    .confidence-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .confidence-high {
      background: #c6f6d5;
      color: #22543d;
    }

    .confidence-medium {
      background: #feebc8;
      color: #7c2d12;
    }

    .confidence-low {
      background: #fed7d7;
      color: #742a2a;
    }

    .postmortem-body {
      margin-bottom: 15px;
    }

    .postmortem-section {
      margin-bottom: 12px;
    }

    .postmortem-label {
      font-size: 12px;
      font-weight: 600;
      color: #4a5568;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 5px;
    }

    .postmortem-text {
      font-size: 14px;
      color: #2d3748;
      line-height: 1.6;
    }

    .fix-details {
      background: #f7f9fc;
      padding: 12px;
      border-radius: 6px;
      margin-top: 8px;
    }

    .postmortem-actions {
      display: flex;
      gap: 10px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #8492a6;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 15px;
      opacity: 0.5;
    }

    .empty-state-text {
      font-size: 16px;
      margin-bottom: 5px;
    }

    .empty-state-subtext {
      font-size: 14px;
    }

    .status-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-passed {
      background: #c6f6d5;
      color: #22543d;
    }

    .status-failed {
      background: #fed7d7;
      color: #742a2a;
    }

    .status-pending {
      background: #feebc8;
      color: #7c2d12;
    }

    .status-approved {
      background: #bee3f8;
      color: #2c5282;
    }

    .status-rejected {
      background: #fed7d7;
      color: #742a2a;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #8492a6;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e1e8ed;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-message {
      background: #fed7d7;
      color: #742a2a;
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>üìä Monitoring Dashboard</h1>
        <p>Live metrics, telemetry events, and reflexion insights</p>
      </div>
      <div class="nav-links">
        <a href="/devops" class="nav-link">DevOps</a>
        <a href="/wizard" class="nav-link">Workflow Wizard</a>
        <a href="/studio" class="nav-link">DAG Studio</a>
        <a href="/test" class="nav-link">Test & Validate</a>
        <a href="/deployment" class="nav-link">Deployments</a>
      </div>
    </div>

    <div class="controls">
      <div class="control-group">
        <label>Time Range:</label>
        <select id="timeRangeSelect">
          <option value="300000">Last 5 minutes</option>
          <option value="900000">Last 15 minutes</option>
          <option value="3600000" selected>Last hour</option>
          <option value="86400000">Last 24 hours</option>
          <option value="">All time</option>
        </select>
      </div>
      <div class="control-group">
        <label>Workflow:</label>
        <input type="text" id="workflowFilter" placeholder="Filter by workflow ID">
      </div>
      <button class="btn btn-primary" onclick="refreshDashboard()">üîÑ Refresh</button>
      <button class="btn btn-secondary" onclick="toggleAutoRefresh()">
        <span id="autoRefreshLabel">‚ñ∂Ô∏è Auto-refresh</span>
      </button>
    </div>

    <div class="content">
      <div id="errorContainer"></div>

      <!-- Metrics Overview -->
      <div class="metrics-grid" id="metricsGrid">
        <div class="metric-card">
          <div class="metric-label">Success Rate</div>
          <div class="metric-value" id="successRate">--%</div>
          <div class="metric-subtitle">Overall task success</div>
        </div>
        <div class="metric-card warning">
          <div class="metric-label">CRV Failures</div>
          <div class="metric-value" id="crvFailures">--</div>
          <div class="metric-subtitle">Blocked commits</div>
        </div>
        <div class="metric-card info">
          <div class="metric-label">Policy Denials</div>
          <div class="metric-value" id="policyDenials">--</div>
          <div class="metric-subtitle">Requires approval</div>
        </div>
        <div class="metric-card success">
          <div class="metric-label">Rollbacks</div>
          <div class="metric-value" id="rollbacks">--</div>
          <div class="metric-subtitle">State restorations</div>
        </div>
      </div>

      <!-- Active Alerts -->
      <div class="section" id="alertsSection" style="display: none;">
        <div class="section-header">
          <h2 class="section-title">‚ö†Ô∏è Active Alerts</h2>
          <button class="btn btn-secondary" onclick="refreshAlerts()">Refresh</button>
        </div>
        <div class="alerts-panel" id="alertsPanel">
          <div class="loading">
            <div class="loading-spinner"></div>
            <div>Loading alerts...</div>
          </div>
        </div>
      </div>

      <!-- BenchRight Evaluation -->
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">üìä BenchRight Quality Evaluation</h2>
          <button class="btn btn-secondary" onclick="refreshBenchRight()">Refresh</button>
        </div>
        <div class="benchright-panel" id="benchrightPanel">
          <div class="loading">
            <div class="loading-spinner"></div>
            <div>Loading evaluation data...</div>
          </div>
        </div>
      </div>

      <!-- Reflexion Insights -->
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">üîç Reflexion Suggestions</h2>
          <button class="btn btn-secondary" onclick="refreshReflexion()">Refresh</button>
        </div>
        <div class="reflexion-panel" id="reflexionPanel">
          <div class="loading">
            <div class="loading-spinner"></div>
            <div>Loading reflexion data...</div>
          </div>
        </div>
      </div>

      <!-- Event Timeline -->
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">üìã Event Timeline</h2>
          <button class="btn btn-secondary" onclick="refreshTimeline()">Refresh</button>
        </div>
        <div class="timeline" id="eventTimeline">
          <div class="loading">
            <div class="loading-spinner"></div>
            <div>Loading events...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let autoRefreshInterval = null;
    let currentWorkflowFilter = '';

    // Get auth token from localStorage
    function getAuthToken() {
      return localStorage.getItem('aureus_token');
    }

    // Make authenticated API request
    async function apiRequest(url, options = {}) {
      const token = getAuthToken();
      if (!token) {
        window.location.href = '/login';
        return;
      }

      const response = await fetch(url, {
        ...options,
        headers: {
          ...options.headers,
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
        },
      });

      if (response.status === 401) {
        localStorage.removeItem('aureus_token');
        window.location.href = '/login';
        return;
      }

      return response;
    }

    // Format date/time
    function formatDateTime(date) {
      const d = new Date(date);
      return d.toLocaleString();
    }

    // Format time ago
    function formatTimeAgo(date) {
      const seconds = Math.floor((new Date() - new Date(date)) / 1000);
      
      if (seconds < 60) return `${seconds}s ago`;
      if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
      if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
      return `${Math.floor(seconds / 86400)}d ago`;
    }

    // Show error message
    function showError(message) {
      const errorContainer = document.getElementById('errorContainer');
      errorContainer.innerHTML = `
        <div class="error-message">
          ‚ö†Ô∏è ${message}
        </div>
      `;
      setTimeout(() => {
        errorContainer.innerHTML = '';
      }, 5000);
    }

    // Load metrics
    async function loadMetrics() {
      try {
        const timeRange = document.getElementById('timeRangeSelect').value;
        const url = timeRange 
          ? `/api/monitoring/metrics?timeRange=${timeRange}`
          : '/api/monitoring/metrics';
        
        const response = await apiRequest(url);
        
        if (!response.ok) {
          throw new Error('Failed to load metrics');
        }

        const data = await response.json();
        
        // Calculate overall success rate
        const successRates = Object.values(data.taskSuccessRateByType);
        const avgSuccessRate = successRates.length > 0
          ? (successRates.reduce((a, b) => a + b, 0) / successRates.length * 100).toFixed(1)
          : 0;
        
        document.getElementById('successRate').textContent = `${avgSuccessRate}%`;
        
        // Get event counts
        const eventsResponse = await apiRequest('/api/monitoring/events');
        const events = await eventsResponse.json();
        
        const crvFailures = events.filter(e => 
          e.type === 'crv_result' && e.data.blocked
        ).length;
        
        const policyDenials = events.filter(e => 
          e.type === 'policy_check' && e.data.requiresHumanApproval
        ).length;
        
        const rollbacks = events.filter(e => 
          e.type === 'rollback'
        ).length;
        
        document.getElementById('crvFailures').textContent = crvFailures;
        document.getElementById('policyDenials').textContent = policyDenials;
        document.getElementById('rollbacks').textContent = rollbacks;
        
      } catch (error) {
        console.error('Error loading metrics:', error);
        showError('Failed to load metrics');
      }
    }

    // Load alerts
    async function loadAlerts() {
      try {
        const timeRangeMs = parseInt(document.getElementById('timeRangeSelect').value) || undefined;
        
        // Get current metrics to calculate alerts
        const response = await apiRequest(`/api/monitoring/metrics${timeRangeMs ? `?timeRange=${timeRangeMs}` : ''}`);
        if (!response.ok) {
          throw new Error('Failed to load metrics for alerts');
        }
        const data = await response.json();
        
        // Calculate alerts based on thresholds
        const alerts = [];
        
        // Success rate alert (below 95%)
        if (data.successRate < 0.95) {
          alerts.push({
            id: 'success-rate',
            severity: data.successRate < 0.80 ? 'critical' : 'warning',
            metric: 'Task Success Rate',
            threshold: 95,
            currentValue: (data.successRate * 100).toFixed(1),
            message: `Task success rate has dropped to ${(data.successRate * 100).toFixed(1)}%. Expected at least 95%.`,
            timestamp: new Date(),
          });
        }
        
        // CRV failures alert (more than 5)
        if (data.crvFailures > 5) {
          alerts.push({
            id: 'crv-failures',
            severity: data.crvFailures > 10 ? 'critical' : 'warning',
            metric: 'CRV Failures',
            threshold: 5,
            currentValue: data.crvFailures,
            message: `High number of CRV failures detected: ${data.crvFailures} blocked commits.`,
            timestamp: new Date(),
          });
        }
        
        // Policy denials alert (more than 10)
        if (data.policyDenials > 10) {
          alerts.push({
            id: 'policy-denials',
            severity: data.policyDenials > 20 ? 'warning' : 'info',
            metric: 'Policy Denials',
            threshold: 10,
            currentValue: data.policyDenials,
            message: `Elevated policy denial rate: ${data.policyDenials} actions requiring approval.`,
            timestamp: new Date(),
          });
        }
        
        // Rollbacks alert (more than 5)
        if (data.rollbacks > 5) {
          alerts.push({
            id: 'rollbacks',
            severity: data.rollbacks > 10 ? 'critical' : 'warning',
            metric: 'Rollbacks',
            threshold: 5,
            currentValue: data.rollbacks,
            message: `High rollback frequency detected: ${data.rollbacks} state restorations.`,
            timestamp: new Date(),
          });
        }
        
        // Show or hide alerts section
        const alertsSection = document.getElementById('alertsSection');
        if (alerts.length > 0) {
          alertsSection.style.display = 'block';
          renderAlerts(alerts);
        } else {
          alertsSection.style.display = 'none';
        }
        
      } catch (error) {
        console.error('Error loading alerts:', error);
        document.getElementById('alertsSection').style.display = 'none';
      }
    }

    // Render alerts panel
    function renderAlerts(alerts) {
      const panel = document.getElementById('alertsPanel');
      
      if (alerts.length === 0) {
        panel.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚úÖ</div>
            <div class="empty-state-text">No Active Alerts</div>
            <div class="empty-state-subtext">All metrics within normal thresholds</div>
          </div>
        `;
        return;
      }
      
      // Sort by severity: critical > warning > info
      const severityOrder = { critical: 0, warning: 1, info: 2 };
      alerts.sort((a, b) => severityOrder[a.severity] - severityOrder[b.severity]);
      
      panel.innerHTML = alerts.map(alert => {
        const icon = alert.severity === 'critical' ? 'üî¥' : alert.severity === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
        
        return `
          <div class="alert-card ${alert.severity}">
            <div class="alert-icon">${icon}</div>
            <div class="alert-content">
              <div class="alert-header">
                <div>
                  <div class="alert-title">${alert.metric}</div>
                  <div class="alert-time">${formatTimeAgo(alert.timestamp)}</div>
                </div>
                <span class="alert-severity ${alert.severity}">${alert.severity}</span>
              </div>
              <div class="alert-message">${alert.message}</div>
              <div class="alert-details">
                <div class="alert-detail">
                  <div class="alert-detail-label">Current Value</div>
                  <div class="alert-detail-value">${alert.currentValue}${typeof alert.currentValue === 'number' && alert.currentValue < 100 ? '%' : ''}</div>
                </div>
                <div class="alert-detail">
                  <div class="alert-detail-label">Threshold</div>
                  <div class="alert-detail-value">${alert.threshold}${alert.threshold < 100 ? '%' : ''}</div>
                </div>
                <div class="alert-detail">
                  <div class="alert-detail-label">Metric</div>
                  <div class="alert-detail-value">${alert.metric}</div>
                </div>
              </div>
              <div class="alert-actions">
                <button class="btn btn-secondary" onclick="acknowledgeAlert('${alert.id}')">Acknowledge</button>
                <button class="btn btn-secondary" onclick="investigateAlert('${alert.id}')">Investigate</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Alert actions
    function acknowledgeAlert(alertId) {
      console.log('Acknowledging alert:', alertId);
      // In a real implementation, this would mark the alert as acknowledged
      alert('Alert acknowledged. This would be persisted in a real implementation.');
    }

    function investigateAlert(alertId) {
      console.log('Investigating alert:', alertId);
      // Navigate to relevant section based on alert
      alert('This would navigate to detailed metrics or logs for investigation.');
    }

    // Load reflexion data
    async function loadReflexion() {
      try {
        const workflowId = currentWorkflowFilter || '';
        
        // Get reflexion stats
        const statsResponse = await apiRequest('/api/reflexion/stats');
        if (!statsResponse.ok) {
          throw new Error('Reflexion not available');
        }
        const stats = await statsResponse.json();
        
        // Get all workflows to fetch postmortems
        const workflowsResponse = await apiRequest('/api/workflows');
        const workflows = await workflowsResponse.json();
        
        let allPostmortems = [];
        for (const workflow of workflows) {
          const pmResponse = await apiRequest(`/api/reflexion/postmortems/${workflow.workflowId}`);
          if (pmResponse.ok) {
            const postmortems = await pmResponse.json();
            allPostmortems = allPostmortems.concat(postmortems);
          }
        }
        
        // Filter by workflow if needed
        if (workflowId) {
          allPostmortems = allPostmortems.filter(pm => pm.workflowId === workflowId);
        }
        
        // Sort by timestamp (newest first)
        allPostmortems.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        // Render postmortems
        renderReflexion(allPostmortems, stats);
        
      } catch (error) {
        console.error('Error loading reflexion:', error);
        document.getElementById('reflexionPanel').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üîç</div>
            <div class="empty-state-text">Reflexion Not Available</div>
            <div class="empty-state-subtext">Reflexion engine is not configured</div>
          </div>
        `;
      }
    }

    // Render reflexion panel
    function renderReflexion(postmortems, stats) {
      const panel = document.getElementById('reflexionPanel');
      
      if (postmortems.length === 0) {
        panel.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚úÖ</div>
            <div class="empty-state-text">No Failure Analysis</div>
            <div class="empty-state-subtext">No postmortems generated yet</div>
          </div>
        `;
        return;
      }
      
      panel.innerHTML = postmortems.map(pm => {
        const confidenceClass = pm.confidence >= 0.7 ? 'high' : pm.confidence >= 0.5 ? 'medium' : 'low';
        const fix = pm.proposedFix;
        
        return `
          <div class="postmortem-card">
            <div class="postmortem-header">
              <div>
                <div class="postmortem-title">
                  ${pm.failureTaxonomy.replace(/_/g, ' ')}
                </div>
                <div class="postmortem-meta">
                  ${formatTimeAgo(pm.timestamp)} ‚Ä¢ Workflow: ${pm.workflowId} ‚Ä¢ Task: ${pm.taskId}
                </div>
              </div>
              <span class="confidence-badge confidence-${confidenceClass}">
                ${(pm.confidence * 100).toFixed(0)}% Confidence
              </span>
            </div>
            
            <div class="postmortem-body">
              <div class="postmortem-section">
                <div class="postmortem-label">Root Cause</div>
                <div class="postmortem-text">${pm.rootCause}</div>
              </div>
              
              <div class="postmortem-section">
                <div class="postmortem-label">Proposed Fix</div>
                <div class="postmortem-text">${fix.description}</div>
                <div class="fix-details">
                  <strong>Fix Type:</strong> ${fix.fixType.replace(/_/g, ' ')}<br>
                  <strong>Risk Tier:</strong> ${fix.riskTier}<br>
                  <strong>Impact:</strong> ${fix.estimatedImpact}
                </div>
              </div>
            </div>
            
            <div class="postmortem-actions">
              <button class="btn btn-primary" onclick="applyFix('${pm.id}')">
                ‚úì Apply Fix
              </button>
              <button class="btn btn-secondary" onclick="dismissPostmortem('${pm.id}')">
                ‚úó Dismiss
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Load event timeline
    async function loadTimeline() {
      try {
        const workflowId = currentWorkflowFilter;
        let url = '/api/monitoring/events';
        
        if (workflowId) {
          url += `?workflowId=${workflowId}`;
        }
        
        const response = await apiRequest(url);
        if (!response.ok) {
          throw new Error('Failed to load events');
        }
        
        const events = await response.json();
        
        // Sort by timestamp (newest first)
        events.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        // Take last 50 events
        const recentEvents = events.slice(0, 50);
        
        renderTimeline(recentEvents);
        
      } catch (error) {
        console.error('Error loading timeline:', error);
        showError('Failed to load event timeline');
      }
    }

    // Render timeline
    function renderTimeline(events) {
      const timeline = document.getElementById('eventTimeline');
      
      if (events.length === 0) {
        timeline.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <div class="empty-state-text">No Events</div>
            <div class="empty-state-subtext">No telemetry events recorded yet</div>
          </div>
        `;
        return;
      }
      
      timeline.innerHTML = events.map(event => {
        const markerClass = getEventMarkerClass(event);
        const description = formatEventDescription(event);
        
        return `
          <div class="timeline-item">
            <div class="timeline-marker ${markerClass}"></div>
            <div class="timeline-content">
              <div class="timeline-time">${formatTimeAgo(event.timestamp)}</div>
              <span class="timeline-type">${event.type}</span>
              <div class="timeline-description">${description}</div>
              ${event.workflowId ? `<div class="timeline-details">Workflow: ${event.workflowId}${event.taskId ? ` | Task: ${event.taskId}` : ''}</div>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    // Get marker class for event type
    function getEventMarkerClass(event) {
      if (event.type === 'step_end' && event.data.success) return 'success';
      if (event.type === 'step_end' && !event.data.success) return 'failure';
      if (event.type === 'crv_result' && !event.data.passed) return 'failure';
      if (event.type === 'policy_check' && !event.data.allowed) return 'warning';
      if (event.type === 'rollback') return 'warning';
      return 'info';
    }

    // Format event description
    function formatEventDescription(event) {
      switch (event.type) {
        case 'step_start':
          return `Started task: ${event.taskType || 'unknown'}`;
        case 'step_end':
          return event.data.success 
            ? `Completed task successfully (${event.data.duration}ms)`
            : `Task failed: ${event.data.error || 'Unknown error'}`;
        case 'tool_call':
          return `Called tool: ${event.data.toolName}`;
        case 'crv_result':
          return event.data.passed 
            ? `CRV passed: ${event.data.gateName}`
            : `CRV failed: ${event.data.gateName}${event.data.blocked ? ' (blocked)' : ''}`;
        case 'policy_check':
          return event.data.allowed 
            ? 'Policy check passed'
            : event.data.requiresHumanApproval 
              ? 'Requires human approval'
              : `Policy denied: ${event.data.reason || 'Unknown reason'}`;
        case 'snapshot_commit':
          return `Snapshot committed: ${event.data.snapshotId}`;
        case 'rollback':
          return `Rollback to ${event.data.snapshotId}: ${event.data.reason}`;
        default:
          return event.type;
      }
    }

    // Apply fix
    async function applyFix(postmortemId) {
      if (!confirm('Are you sure you want to apply this fix?')) {
        return;
      }
      
      showError('Fix application not yet implemented in this demo');
    }

    // Dismiss postmortem
    function dismissPostmortem(postmortemId) {
      if (!confirm('Are you sure you want to dismiss this postmortem?')) {
        return;
      }
      
      showError('Dismiss functionality not yet implemented in this demo');
    }

    // Load BenchRight evaluation data
    async function loadBenchRight() {
      try {
        const timeRange = document.getElementById('timeRangeSelect').value;
        const summaryUrl = timeRange 
          ? `/api/benchright/summary?timeRange=${timeRange}`
          : '/api/benchright/summary';
        
        const reportUrl = timeRange 
          ? `/api/benchright/report?timeRange=${timeRange}`
          : '/api/benchright/report';
        
        const summaryResponse = await apiRequest(summaryUrl);
        const reportResponse = await apiRequest(reportUrl);
        
        if (!summaryResponse.ok || !reportResponse.ok) {
          throw new Error('BenchRight not available');
        }

        const summary = await summaryResponse.json();
        const report = await reportResponse.json();
        
        renderBenchRight(summary, report);
        
      } catch (error) {
        console.error('Error loading BenchRight:', error);
        document.getElementById('benchrightPanel').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìä</div>
            <div class="empty-state-text">BenchRight Not Available</div>
            <div class="empty-state-subtext">Quality evaluation is not configured</div>
          </div>
        `;
      }
    }

    // Render BenchRight data
    function renderBenchRight(summary, report) {
      const panel = document.getElementById('benchrightPanel');
      
      const gradeColor = (grade) => {
        const colors = { A: 'score-grade-A', B: 'score-grade-B', C: 'score-grade-C', D: 'score-grade-D', F: 'score-grade-F' };
        return colors[grade] || 'score-grade-C';
      };

      const getInterventionClass = (value) => {
        if (value > 0.7) return 'intervention-value-high';
        if (value > 0.4) return 'intervention-value-medium';
        return 'intervention-value-low';
      };

      const getInterventionText = (value) => {
        if (value > 0.7) return 'High value';
        if (value > 0.4) return 'Moderate value';
        return 'Low value';
      };
      
      let html = `
        <div class="benchright-summary">
          <div class="benchright-metric">
            <div class="benchright-metric-label">Overall Score</div>
            <div class="benchright-metric-value">${summary.overallAverageScore.toFixed(1)}</div>
            <div class="benchright-metric-subtitle">Out of 100</div>
          </div>
          <div class="benchright-metric">
            <div class="benchright-metric-label">Pass Rate</div>
            <div class="benchright-metric-value">${(summary.passRate * 100).toFixed(0)}%</div>
            <div class="benchright-metric-subtitle">${summary.totalTraces} traces</div>
          </div>
          <div class="benchright-metric">
            <div class="benchright-metric-label">Reasoning</div>
            <div class="benchright-metric-value">${summary.averageReasoningCoherence.toFixed(1)}</div>
            <div class="benchright-metric-subtitle">Coherence score</div>
          </div>
          <div class="benchright-metric">
            <div class="benchright-metric-label">Cost/Value</div>
            <div class="benchright-metric-value">${summary.averageCostValue.toFixed(1)}</div>
            <div class="benchright-metric-subtitle">Efficiency score</div>
          </div>
          <div class="benchright-metric">
            <div class="benchright-metric-label">Counterfactual</div>
            <div class="benchright-metric-value">${summary.averageCounterfactual.toFixed(1)}</div>
            <div class="benchright-metric-subtitle">Action value</div>
          </div>
        </div>
        <div class="benchright-scores">
      `;
      
      // Show top 5 scores
      const topScores = report.scores.slice(0, 5);
      
      for (const score of topScores) {
        const counterfactual = report.counterfactualSimulations?.find(s => s.traceId === score.traceId);
        
        html += `
          <div class="score-card">
            <div class="score-header">
              <div class="score-title">Trace ${score.traceId.substring(0, 8)}...</div>
              <div class="score-badge ${gradeColor(score.grade)}">
                ${score.overallScore.toFixed(0)} (${score.grade})
              </div>
            </div>
            <div class="score-metrics">
              <div class="score-metric">
                <div class="score-metric-label">Output Quality</div>
                <div class="score-metric-value">${score.outputQuality.score.toFixed(0)}</div>
              </div>
              <div class="score-metric">
                <div class="score-metric-label">Reasoning</div>
                <div class="score-metric-value">${score.reasoningCoherence.score.toFixed(0)}</div>
              </div>
              <div class="score-metric">
                <div class="score-metric-label">Cost/Value</div>
                <div class="score-metric-value">${score.costValue.score.toFixed(0)}</div>
              </div>
              <div class="score-metric">
                <div class="score-metric-label">Hypothesis</div>
                <div class="score-metric-value">${score.hypothesisSwitching.score.toFixed(0)}</div>
              </div>
            </div>
        `;
        
        if (counterfactual) {
          html += `
            <div class="counterfactual-section">
              <div class="counterfactual-title">Counterfactual Analysis</div>
              <div class="counterfactual-comparison">
                <div class="counterfactual-outcome">
                  <strong>Actual:</strong> ${counterfactual.actualOutcome}
                </div>
                <div class="counterfactual-arrow">‚Üí</div>
                <div class="counterfactual-outcome">
                  <strong>Do Nothing:</strong> ${counterfactual.doNothingOutcome}
                </div>
              </div>
              <div class="intervention-value ${getInterventionClass(counterfactual.interventionValue)}">
                Intervention Value: ${(counterfactual.interventionValue * 100).toFixed(0)}% - ${getInterventionText(counterfactual.interventionValue)}
              </div>
              <div style="font-size: 11px; color: #718096; margin-top: 6px;">
                ${counterfactual.necessaryActions.length} necessary, ${counterfactual.wastedActions.length} wasted actions
              </div>
            </div>
          `;
        }
        
        html += '</div>';
      }
      
      html += '</div>';
      
      panel.innerHTML = html;
    }

    // Refresh dashboard
    async function refreshDashboard() {
      await Promise.all([
        loadMetrics(),
        loadAlerts(),
        loadBenchRight(),
        loadReflexion(),
        loadTimeline()
      ]);
    }

    // Refresh individual sections
    async function refreshBenchRight() {
      await loadBenchRight();
    }

    async function refreshReflexion() {
      await loadReflexion();
    }

    async function refreshAlerts() {
      await loadAlerts();
    }

    async function refreshTimeline() {
      await loadTimeline();
    }

    // Toggle auto-refresh
    function toggleAutoRefresh() {
      const label = document.getElementById('autoRefreshLabel');
      
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        label.textContent = '‚ñ∂Ô∏è Auto-refresh';
      } else {
        autoRefreshInterval = setInterval(refreshDashboard, 10000); // Refresh every 10 seconds
        label.textContent = '‚è∏Ô∏è Auto-refresh';
      }
    }

    // Handle workflow filter
    document.getElementById('workflowFilter').addEventListener('change', (e) => {
      currentWorkflowFilter = e.target.value.trim();
      refreshDashboard();
    });

    // Handle time range change
    document.getElementById('timeRangeSelect').addEventListener('change', () => {
      loadMetrics();
    });

    // Initial load
    refreshDashboard();

    // Initialize persona features
    window.addEventListener('DOMContentLoaded', function() {
      if (typeof personaManager !== 'undefined') {
        addPersonaBadge();
        
        // Only admins and devops can see full monitoring
        if (!personaManager.hasPermission('viewMonitoring')) {
          document.body.innerHTML = '<h1 style="text-align:center; margin-top:50px;">Access Denied</h1>';
        }
      }
    });
  </script>
</body>
</html>
